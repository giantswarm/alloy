alloy:
  alloy:
    configMap:
      create: true
      content: |
        // Select PodLogs with foo=bar label in all namespaces.
        loki.source.podlogs "default" {
          forward_to = [loki.process.default.receiver]
          selector {
            match_labels = {
              "foo" = "bar",
            }
          }
        }

        // Filter log entries.
        loki.process "default" {
          forward_to = [loki.write.default.receiver]

          // Parse log entries as JSON and drop invalid ones.
          stage.json {
            expressions = {entry = ""}
            drop_malformed = true
          }

          // Drop log entries with level=debug.
          // For example this would drop {"level":"debug","msg":"debug message"}
          stage.drop {
            source = "level"
            value = "debug"
          }
        }

        // Send log entries to Loki.
        loki.write "default" {
          endpoint {
            url = "https://loki-gateway.loki/loki/api/v1/push"
          }
        }
